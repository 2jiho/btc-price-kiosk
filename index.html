<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json" />
    <link
      rel="icon"
      href="./bitcoin-btc-logo.svg"
      type="image/svg+xml"
    />
    <title>비트코인 실시간 가격</title>
    <style>
      :root {
        --reference-size: calc(min(1vw, 2vh));
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        width: 100vw;
        background-color: #000;
        color: #ffffff;
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        overflow: hidden;
        user-select: none; /* 텍스트 선택 방지 */
      }
      #container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative; /* 추가된 부분 */
      }
      #icon {
        height: calc(var(--reference-size) * 15);
        margin-right: calc(var(--reference-size) * 5);
      }
      #price-krw {
        margin: 0;
        font-size: calc(var(--reference-size) * 5);
        margin-right: calc(var(--reference-size) * 5);
      }
      #price-usd {
        margin: 0;
        font-size: calc(var(--reference-size) * 3);
        margin-right: calc(var(--reference-size) * 5);
      }
      #change {
        margin: 0;
        font-size: calc(var(--reference-size) * 3);
      }
      #change-label {
        margin: 0;
        font-size: calc(var(--reference-size) * 2);
        color: gray;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <img src="./bitcoin-btc-logo.svg" id="icon" />
      <div>
        <p id="price-krw"></p>
        <p id="price-usd"></p>
      </div>
      <div>
        <p id="change"></p>
        <p id="change-label">24h</p>
      </div>
    </div>

    <script>
      // ========== 설정 상수 ==========
      const CONFIG = {
        DEBUG_MODE: false, // 프로덕션에서는 false로 설정
        EXCHANGE_RATE_UPDATE_INTERVAL: 6 * 60 * 1000, // 6분
        PRICE_UPDATE_INTERVAL: 2000, // 2초
        BURNIN_PREVENTION_INTERVAL: 60 * 1000, // 60초
        BURNIN_PREVENTION_STEP: 10, // 10px
        BURNIN_PREVENTION_LIMIT: 0.1, // 화면의 10%
        PRICE_ANIMATION_DURATION: 500, // 0.5초
        WEBSOCKET_RECONNECT_DELAY: 3000, // 3초
        WEBSOCKET_RETRY_DELAY: 1000, // 1초
        DEFAULT_KRW_USD_RATE: 1400,
        BTC_SYMBOL: "BTCUSDT",
      };

      // 디버그 로깅 헬퍼
      const log = {
        debug: (...args) => CONFIG.DEBUG_MODE && console.debug(...args),
        info: (...args) => console.log(...args),
        warn: (...args) => console.warn(...args),
        error: (...args) => console.error(...args),
      };

      // ========== 환율 부분 시작 ==========
      let krwUsdRate = CONFIG.DEFAULT_KRW_USD_RATE;
      let exchangeRateError = false;

      async function fetchExchangeRate() {
        try {
          const response = await fetch(
            "https://api.manana.kr/exchange/rate/KRW/USD.json"
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          if (data && data[0] && data[0].rate) {
            krwUsdRate = data[0].rate;
            exchangeRateError = false;
            log.info(`환율 업데이트 완료: ${krwUsdRate.toFixed(2)} KRW/USD`);
          } else {
            throw new Error("Invalid exchange rate data format");
          }
        } catch (error) {
          exchangeRateError = true;
          log.error("환율 가져오기 실패:", error);
          log.warn(
            `기본 환율(${CONFIG.DEFAULT_KRW_USD_RATE} KRW/USD) 사용 중`
          );
        }
      }

      fetchExchangeRate();
      setInterval(fetchExchangeRate, CONFIG.EXCHANGE_RATE_UPDATE_INTERVAL);
      // ========== 환율 부분 끝 ==========

      // ========== BTC 가격 부분 시작 ==========
      let ws;
      let lastPrice = 0;
      let reconnectTimeout;
      let priceUpdateInterval;

      function connectWebSocket() {
        // 기존 연결이 있으면 정리
        if (ws) {
          ws.close();
        }

        ws = new WebSocket("wss://ws-api.binance.com/ws-api/v3");

        ws.onopen = function () {
          log.info("WebSocket 연결 성공");
          ws.send(
            JSON.stringify({
              id: crypto.randomUUID(),
              method: "ping",
            })
          );
        };

        ws.onmessage = function (event) {
          const response = JSON.parse(event.data);
          log.debug("Received data:", response);

          if (response.error) {
            log.error("WebSocket 에러:", response.error);
            return;
          }

          // response.result가 존재하는지 확인
          if (!response.result) {
            log.warn("response.result가 없습니다:", response);
            return;
          }

          if (Object.keys(response.result).length === 0) {
            // 핑퐁 처리
            log.info("WebSocket 연결됨 (ping/pong)");
            sendTickerRequest(); // 가격 바로 가져오기
          } else if (response.result.symbol === CONFIG.BTC_SYMBOL) {
            // 가격 처리
            updatePrice(response.result);
          }

          // Rate limit 체크
          if (response.rateLimits && response.rateLimits[0]) {
            const rateLimit = response.rateLimits[0];
            log.debug(
              `Rate limit: ${rateLimit.count}/${rateLimit.limit} requests/min`
            );

            // Rate limit의 80%에 도달하면 경고
            if (rateLimit.count / rateLimit.limit > 0.8) {
              log.warn("Rate limit 80% 도달. 요청 빈도를 줄이는 것을 권장합니다.");
            }
          }
        };

        ws.onclose = function (event) {
          log.warn("WebSocket 연결 종료:", event.code, event.reason);
          // 자동 재연결
          clearTimeout(reconnectTimeout);
          reconnectTimeout = setTimeout(() => {
            log.info("WebSocket 재연결 시도 중...");
            connectWebSocket();
          }, CONFIG.WEBSOCKET_RECONNECT_DELAY);
        };

        ws.onerror = function (error) {
          log.error("WebSocket 에러:", error);
        };
      }

      function sendTickerRequest() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              id: crypto.randomUUID(),
              method: "ticker.24hr",
              params: {
                symbol: CONFIG.BTC_SYMBOL,
              },
            })
          );
        } else {
          log.debug("WebSocket이 아직 연결되지 않았습니다. 재시도 중...");
          setTimeout(sendTickerRequest, CONFIG.WEBSOCKET_RETRY_DELAY); // 버그 수정: 괄호 제거
        }
      }

      function updatePrice(data) {
        if (!data || !data.lastPrice) {
          log.error("잘못된 데이터:", data);
          return;
        }

        const priceUSD = parseFloat(data.lastPrice);
        const priceKRW = priceUSD * krwUsdRate;
        const percentChange = parseFloat(data.priceChangePercent);

        log.debug({
          priceUSD: priceUSD,
          priceKRW: priceKRW,
          percentChange: percentChange,
          exchangeRateError: exchangeRateError,
        });

        // USD 가격 표시
        const formattedPriceUSD = priceUSD.toLocaleString(undefined, {
          style: "currency",
          currency: "USD",
          currencyDisplay: "narrowSymbol",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
        document.getElementById("price-usd").innerText = formattedPriceUSD;

        // KRW 가격 표시
        const formattedPriceKRW = priceKRW.toLocaleString(undefined, {
          style: "currency",
          currency: "KRW",
          currencyDisplay: "narrowSymbol",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        const krwText = exchangeRateError
          ? `${formattedPriceKRW} (추정)`
          : formattedPriceKRW;
        document.getElementById("price-krw").innerText = krwText;

        // 24시간 변화율 표시
        const formattedChange = `${
          percentChange >= 0 ? "+" : ""
        }${percentChange.toFixed(2)}%`;
        const changeElement = document.getElementById("change");
        changeElement.innerText = formattedChange;
        if (percentChange > 0) {
          changeElement.style.color = "lightgreen";
        } else if (percentChange < 0) {
          changeElement.style.color = "lightcoral";
        } else {
          changeElement.style.color = "white";
        }

        // 가격 변화에 따른 애니메이션 효과
        const priceElement = document.getElementById("price-usd");
        if (priceUSD > lastPrice) {
          priceElement.style.color = "green";
        } else if (priceUSD < lastPrice) {
          priceElement.style.color = "maroon";
        }
        setTimeout(() => {
          priceElement.style.color = "gray";
        }, CONFIG.PRICE_ANIMATION_DURATION);

        lastPrice = priceUSD;
      }

      // 페이지 로드 시 WebSocket 연결
      connectWebSocket();

      // 주기적으로 가격 업데이트 요청
      priceUpdateInterval = setInterval(
        sendTickerRequest,
        CONFIG.PRICE_UPDATE_INTERVAL
      );
      // ========== BTC 가격 부분 끝 ==========

      // ========== 화면 번인 방지 시작 ==========
      const container = document.getElementById("container");
      let offsetX = 0;
      let offsetY = 0;
      let limitX = 50;
      let limitY = 50;

      function moveContainer() {
        // 화면 크기에 따라 이동량 제한
        limitX =
          ((window.innerWidth - container.offsetWidth) / 2) *
          CONFIG.BURNIN_PREVENTION_LIMIT;
        limitY =
          ((window.innerHeight - container.offsetHeight) / 2) *
          CONFIG.BURNIN_PREVENTION_LIMIT;
        limitX = Math.floor(limitX);
        limitY = Math.floor(limitY);

        // 새로운 위치 계산
        offsetX +=
          (Math.random() < 0.5 ? 1 : -1) * CONFIG.BURNIN_PREVENTION_STEP;
        offsetY +=
          (Math.random() < 0.5 ? 1 : -1) * CONFIG.BURNIN_PREVENTION_STEP;

        // 최대 움직임 제한
        offsetX = Math.max(Math.min(offsetX, limitX), -limitX);
        offsetY = Math.max(Math.min(offsetY, limitY), -limitY);

        // 요소 위치 이동
        container.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
        log.debug(`translate(${offsetX}px, ${offsetY}px)`);
      }

      // 번인 방지 반복
      setInterval(moveContainer, CONFIG.BURNIN_PREVENTION_INTERVAL);
      // ========== 화면 번인 방지 끝 ==========

      // ========== Wake Lock (화면 꺼짐 방지) 시작 ==========
      let wakeLock = null;

      async function enableWakeLock() {
        if (document.visibilityState !== "visible") {
          log.warn("페이지가 보이지 않습니다. Wake Lock을 요청할 수 없습니다.");
          return;
        }

        try {
          wakeLock = await navigator.wakeLock.request("screen");
          log.info("Wake Lock 활성화: 화면이 꺼지지 않습니다.");
        } catch (err) {
          log.error(`Wake Lock 에러: ${err.name} - ${err.message}`);
        }
      }

      async function releaseWakeLock() {
        if (wakeLock) {
          await wakeLock.release();
          wakeLock = null;
          log.info("Wake Lock 해제됨");
        }
      }

      // 페이지 가시성 변경 시 Wake Lock 관리
      document.addEventListener("visibilitychange", async () => {
        if (document.visibilityState === "visible") {
          await enableWakeLock();
        } else {
          await releaseWakeLock();
        }
      });

      enableWakeLock();
      // ========== Wake Lock 끝 ==========

      // ========== 터치 밝기 조절 시작 ==========
      let light = true;
      document.body.addEventListener("click", () => {
        light = !light;
        document.body.style.filter = `brightness(${light ? 100 : 50}%)`;
        log.debug(`밝기: ${light ? "100%" : "50%"}`);
      });
      // ========== 터치 밝기 조절 끝 ==========

      // ========== 전체 화면 시 커서 숨김 시작 ==========
      document.addEventListener("mousemove", () => {
        if (
          screen.width === window.innerWidth &&
          screen.height === window.innerHeight
        ) {
          document.body.style.cursor = "none";
        } else {
          document.body.style.cursor = "auto";
        }
      });
      // ========== 전체 화면 시 커서 숨김 끝 ==========
    </script>
  </body>
</html>
